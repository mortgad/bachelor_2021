---
title: "wordshoal"
author: "Gustav Helms"
date: "11/8/2021"
output: html_document
---

```{r}
# loading packages
pacman::p_load(tidyverse, corpus, devtools, lubridate, flux)

# Installing the latest version of quanteda and wordshoal
#devtools::install_github("https://github.com/quanteda/quanteda")
#remotes::install_github("kbenoit/wordshoal")

# Loading the packages
library(quanteda)
library(wordshoal)
library(quanteda.textmodels)
```


```{r}
# Importing data
df <- read_csv("./data/folketinget_2009_2021_raw.csv")

# Making a month and year unique variable
df <- df %>% mutate(
  month_year_id = paste0(Year,"_", month(Date))
) %>% select(-c(Title))

```

# --------------------------------------------------------------------------------------------------------------
# Implementing the wordshoal function on our own data

```{r}
# Making the df into a corpus
corpus <- corpus(dfny)

# Create a data frame matrix (dfm)
dfm <- dfm(tokens(corpus), remove_punct = TRUE)

# Fitting the model
wordshoalfit <- 
    textmodel_wordshoal(dfm, #dir = c(7,1), # I cannot figure out what the 'dir' argument does
                        groups = docvars(corpus, "id"), 
                        authors = docvars(corpus, "Name"))

# Inspecting the output
summary(wordshoalfit) 

```


```{r}
# Aggregating to get the positions of the mean positon of the parties
author_positions <- summary(wordshoalfit)$estimated.author.positions
author_positions$row_names <- rownames(author_positions)

fitdf <- merge(author_positions,
               docvars(corpus), 
               by.x = "row_names", by.y = "Name")
fitdf <- subset(fitdf, !duplicated(row_names))


aggregate(theta ~ Parti, data = fitdf, mean)
```

# Loop through unique id's in csv and wordshoal each "pdf"


```{r}
######### Corpus per pdf #######
dfny <- df %>% filter(id %in% c("20201_M108_referat", "20201_M114_referat")) %>% group_by(id) %>% slice(1:100) %>% ungroup() # subset data
pdf = unique(dfny$id) # input list
   
i = 1
wordshoaler <- function(doc) {
  cat(paste0("[ ] Shoaling ", doc, "\n"))
  shoal_df = dfny %>% filter(id == paste0(doc))
  corpuseret = quanteda::corpus(shoal_df)
  dfmmm <- dfm(tokens(corpuseret), remove_punct = TRUE) # matrix making
  wordshoalfit <- wordshoal::textmodel_wordshoal(dfmmm, groups = docvars(corpuseret, "id"), 
                                                 authors = docvars(corpuseret, "Name"))
  author_positions <- summary(wordshoalfit)$estimated.author.positions
  author_positions$row_names <- rownames(author_positions)

  fitdf <- merge(author_positions,
               docvars(corpuseret), 
               by.x = "row_names", by.y = "Name")
  fitdf <- subset(fitdf, !duplicated(row_names))
  thetascores <<- rbind(thetascores, fitdf)

}
#column_names = c("row_names", "theta", "se", "Title", "id", "Samling", "Nr", "Titel", "Dato", "speaker_id", "Date", "Year", "Parti", "Period", "n_words")
thetascores <- data.frame()
map(pdf, wordshoaler)

```

```{r}
############## corpus per month ###################
dfny <- df %>% group_by(month_year_id) %>% slice(1:100) %>% ungroup() %>% group_by(id) %>% filter(n() > 10) # subset data (only keeping pdf-groups with n > 10). 

#dfny %>% group_by(id) %>% summarise(n()) # to see number of rows per pdf

years_2019_2020 <- dfny %>% filter(Year %in% c(2019,2020))
months = unique(years_2019_2020$month_year_id)  # input list

#months %>% sort()
#hep <- years_2019_2020 %>% filter(month_year_id == "2019_11") # see if wordshoal finds amount of documents per month
#unique(hep$id)

wordshoaler <- function(doc) {
  cat(paste0("[ ] Shoaling ", doc, "\n"))
  shoal_df = years_2019_2020 %>% filter(month_year_id == paste0(doc))
  corpuseret = quanteda::corpus(shoal_df)
  dfmmm <- dfm(tokens(corpuseret), remove_punct = TRUE) # matrix making
  wordshoalfit <- wordshoal::textmodel_wordshoal(dfmmm, groups = docvars(corpuseret, "id"), 
                                                 authors = docvars(corpuseret, "Name"))
  author_positions <- summary(wordshoalfit)$estimated.author.positions
  author_positions$row_names <- rownames(author_positions)

  fitdf <- merge(author_positions,
               docvars(corpuseret), 
               by.x = "row_names", by.y = "Name")
  fitdf <- subset(fitdf, !duplicated(row_names))
  thetascores <<- rbind(thetascores, fitdf)

}

thetascores <- data.frame()
map(months, wordshoaler)
```

# The following example is the one provided in the documentation for the function. This one works. Maybe the answer is here somehow. 

```{r}
# Inspecting the data
summary(data_corpus_irish30)

```

```{r}
texts(corpus)[5]
```

```{r}
iedfm <- dfm(data_corpus_irish30, remove_punct = TRUE) 

wordshoalfit <- 
    textmodel_wordshoal(iedfm, dir = c(7,1),
                        groups = docvars(data_corpus_irish30, "debateID"), 
                        authors = docvars(data_corpus_irish30, "member.name"))

summary(wordshoalfit)                    

author_positions <- summary(wordshoalfit)$estimated.author.positions
author_positions$row_names <- rownames(author_positions)
fitdf <- merge(author_positions,
               docvars(data_corpus_irish30), 
               by.x = "row_names", by.y = "member.name")
fitdf <- subset(fitdf, !duplicated(memberID))
aggregate(theta ~ party.name, data = fitdf, mean)
```
