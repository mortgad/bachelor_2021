hep = read_csv("./data/folketinget_2019_2021_raw.csv")
library(tidyverse)
hep = read_csv("./data/folketinget_2019_2021_raw.csv")
View(hep)
library(tidyverse)
library(lubridate)
library(groupdata2)
library(fuzzyjoin)
# library(udpipe)
library(stopwords)
title_re_paren = "(?<=\\().*(?=\\))"
title_re_noparen = ".*"
name_re = "[\\w\\s-\\.]+"
# load in metadata
meta = read_delim("./data/metadata_for_scraping/metadata.csv", ";", col_types = cols()) %>%
mutate(id = tools::file_path_sans_ext(basename(PDF))) %>%
select(-PDF, -X6)
View(meta)
tidy_text <- function(filename) {
cat(paste0("[ ] Tidying ", filename, "\n"))
d = read_delim(filename, delim = ";", col_types = cols()) %>%
filter(complete.cases(reason))
if (nrow(d) < 3) return(data.frame(NA))
if (!any(str_detect(d$reason, "name"))) return (data.frame(NA))
d = d %>%
filter(split > 0) %>%
mutate(value = case_when(
reason == "title_name" ~ ifelse(
str_detect(value, "\\(|\\)"),
str_extract(value, title_re_paren),
str_extract(value, title_re_noparen)),
reason == "name_party" ~ str_extract(value, name_re),
reason == "Time" ~ value),
reason = ifelse(reason == "Time", "Time", "Name"),
value = trimws(value)) %>%
spread(reason, value) %>%
select(-split)
if ("Time" %in% colnames(d)) {
d = d %>%
fill(Time, Name) %>%
mutate(Time = hm(Time))
} else {
d$Time = hm(NA)
}
d = d %>%
filter(complete.cases(text), complete.cases(Name)) %>%
mutate(id = tools::file_path_sans_ext(basename(filename))) %>%
as_data_frame()
return(d)
}
files = list.files("./data/segmented", "*.txt", full.names = TRUE)
data = map_dfr(files, tidy_text) %>%
## bind_rows() %>%
right_join(meta, by = "id") %>%
mutate(Date = parse_date_time(str_c(Dato, Time, sep = " "),
orders = c("dmy HMS", "dmy MS", "dmy S"))) %>%
filter(complete.cases(Date)) %>%
arrange(Date) %>%
mutate(speaker_id = ifelse(lag(Name) != Name, 1, 0) %>%
coalesce(0) %>%
cumsum()) %>%
group_by(Name, id, Samling, Nr, Titel, Dato, speaker_id) %>%
summarise(text = str_c(text, collapse = " "),
Date = min(Date)) %>% ungroup() %>%
mutate(doc_id = as.character(as.integer(as.factor(str_c(speaker_id, Name, Date))))) %>%
ungroup()
View(data)
test_file = read_delim("./data/segmented/20191_M1_referat.txt", delim = ";")
View(test_file)
