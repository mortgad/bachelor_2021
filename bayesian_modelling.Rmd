---
title: "baysian_modelling"
author: "Gustav Helms"
date: "11/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Loading packages
pacman::p_load(tidyverse, brms, here)
```


```{r}
# Load results dataframe
results <- read_csv("./data/agg_results_2009_2021.csv") %>% 
  # Creating date variable
  mutate(
  Date = str_replace(month_year_id, "_", "-"),
  Date = as.Date(paste0(Date, "-01"))
)

######## Preprocessing #########3
# Agregating results into a single data frame - VERY MESSY i know
agg <- results %>% group_by(Parti, Date) %>% arrange(-overlap_score, .by_group = TRUE) %>% slice(1:3) %>%
  summarise(overlap_score = mean(overlap_score),
            difference_score = mean(difference_score)) 

agg <- left_join(x = agg, y = results %>% dplyr::select(Parti, Date, mean_theta, sd_theta), by = c("Parti" = "Parti", "Date" = "Date")) %>% group_by(Parti, Date) %>% slice(1) %>% ungroup()

# Adding a lag column for the predictors - difference_score and sd_theta
agg <- agg  %>%  mutate(
  Inclusion = sd_theta,
  Differentiation = difference_score
) %>% group_by(Parti) %>% mutate(
  Lag_inclusion = lag(Inclusion),
  Lag_differentiation = lag(Differentiation)
)

# Removing NA and 0 values
agg <- na.omit(agg) %>% filter(mean_theta != 0 & sd_theta != 0)
```


```{r}
#checking out the outome variable
summary(agg$Inclusion)
ggplot(agg, aes(x = Inclusion)) + 
  geom_density()
```

```{r, fig.width= 15, fig.height= 5}
#plotting the raw data
agg %>% group_by(Date) %>% summarise(Inclusion = mean(sd_theta),
                                     Differentiation = mean(lag_difference_score)) %>% pivot_longer(cols = c("Inclusion", "Differentiation"), names_to = "Need") %>% 
  ggplot()+
  aes(x = Date, y = value, color = Need)+
  geom_line()+
  geom_point()
```

```{r}
###################### DEFINING MODEL AND MAKING PRIOR-PREDICTIVE CHECKS ######################

f1 <- bf(Inclusion ~ 1 + Lag_inclusion + Lag_differentiation + Lag_inclusion:Lag_differentiation + (1|Parti), family = lognormal())

get_prior(f1, data = agg)

# Finding prior for random intercept
means <- agg %>% group_by(Parti, Date) %>% summarise(mean = mean(sd_theta),
                                      sd = sd(sd_theta)) %>% summarise(mean_of_mean = mean(mean),
                                                                       sd_of_mean = sd(mean))


mean(means$mean_of_mean)
# Mean of 0.4606071

mean(means$sd_of_mean)
# sd of 0.2353983

prior_m1 <- c(
  prior(normal(-0.8766658, 0.2), class = Intercept),
  prior(normal(0, 0.2), class = b),
  prior(normal(0.4486, 0.2428), class = sd),
  prior(normal(0.5761837, 0.2), class = sigma)
)

# Running the model
m1_prior <- brm(
  formula = f1,
  data = na.omit(agg),
  family = lognormal(),
  prior = prior_m1, 
  sample_prior = "only",
  chains = 1,
  cores = 1,
  backend = "cmdstanr"
  #file = here("models", "m1_prior")
  )


# Prior predictive check
pp_check(m1_prior, nsamples = 100)
```


```{r}
############################ RUNNING THE MODEL WITH DATA  #####################################
# Running the model
m1 <- brm(
  formula = f1,
  data = na.omit(agg),
  family = gaussian(),
  prior = prior_m1, 
  sample_prior = T,
  chains = 1,
  cores = 1,
  backend = "cmdstanr"#,
  #file = here("models", "m1")
  )


# Posterior predictive check
pp_check(m1, nsamples = 100)

```


```{r}
# Diagnostics 
# Summary output
print(m1)

#Checking the chains
plot(m1)
#Catterpillars look damn fine
```

```{r}
#---------------------------------prior-posterior update------------------------

#Prior posterior update checks
m1_samples <- posterior_samples(m1)
m1_samples %>% 
  select(c("b_Lag_inclusion", "b_Lag_differentiation", "b_Lag_inclusion:Lag_differentiation", "sd_Parti__Intercept", "sigma", "Intercept",
           "prior_Intercept", "prior_b", "prior_sd_Parti", "prior_sigma")) %>% 
  rename(
    b_lagInclusion = b_Lag_inclusion,
    b_lagDifferentiation = b_Lag_differentiation,
    b_Interaction = "b_Lag_inclusion:Lag_differentiation",
    b_sdParti = sd_Parti__Intercept,
    b_sigma = sigma,
    b_Intercept = Intercept, 
    prior_Intercept = prior_Intercept,
    prior_sdParti = prior_sd_Parti,
  ) %>% 
  mutate(
    prior_lagInclusion = prior_b,
    prior_lagDifferentiation = prior_b,
    prior_Interaction = prior_b
  ) %>% select(-prior_b) %>% 
  pivot_longer(cols = everything(),
               values_to = "value",
               names_to = "distribution"
               ) %>% 
  separate(distribution, c("Distribution", "Parameter"), sep = "_") %>% 
  mutate(Distribution = ifelse(Distribution == "b", "Posterior", "Prior")) %>% 
  ggplot(aes(x = value, fill = Distribution)) + 
  geom_density(alpha = 0.8) +
  facet_wrap(~Parameter, nrow = 4) +
  labs(title = "Prior-posterior updates")+
  theme_bw()+
  scale_fill_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) + 
  theme(strip.text = element_text(size=15),
        axis.title=element_text(size=15),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5)) + 
  xlim(-1,1)
```

```{r, fig.width= 10, fig.height=4}
#---------------------------------prior-posterior update - a little closer look ------------------------

#Prior posterior update checks
m1_samples <- posterior_samples(m1)
m1_samples %>% 
  select(c("b_Lag_inclusion", "b_Lag_differentiation", "b_Lag_inclusion:Lag_differentiation",
            "prior_b")) %>% 
  rename(
    b_lagInclusion = b_Lag_inclusion,
    b_lagDifferentiation = b_Lag_differentiation,
    b_Interaction = "b_Lag_inclusion:Lag_differentiation"
  ) %>% 
  mutate(
    prior_lagInclusion = prior_b,
    prior_lagDifferentiation = prior_b,
    prior_Interaction = prior_b
  ) %>% select(-prior_b) %>% 
  pivot_longer(cols = everything(),
               values_to = "value",
               names_to = "distribution"
               ) %>% 
  separate(distribution, c("Distribution", "Parameter"), sep = "_") %>% 
  mutate(Distribution = ifelse(Distribution == "b", "Posterior", "Prior")) %>% 
  ggplot(aes(x = value, fill = Distribution)) + 
  geom_density(alpha = 0.8) +
  facet_wrap(~Parameter, nrow = 1) +
  labs(title = "Prior-posterior updates")+
  theme_bw()+
  scale_fill_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) + 
  theme(strip.text = element_text(size=15),
        axis.title=element_text(size=15),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5)) + 
  xlim(-1,1)
```

```{r}
# ------------------------------- Plotting conditional effects --------------------------------------------
plot(conditional_effects(m1, spaghetti=F, 
                         method="fitted", nsamples=100), points=T)

plot(conditional_effects(m1, spaghetti=F, 
                         method="predict", nsamples=100), points=T)

```


```{r}
#------------------------------------influential data points and LOO------------

#check for influential data-points
# m2_no_meta <- add_criterion(m2_no_meta, "loo", reloo = T)
#3 problematic observation(s) found.

plot(loo(m1))
#How to look at this plot?

```
```{r}
#-----------------------------------Results-------------------------------------

#checking the output of the model
print(m1)
mcmc_plot(m1) +
  theme(axis.text.y = element_text(hjust = 0))


#test your hypotheses
# Significant effect of Diagnosis in DK?
hypothesis(m1, "Lag_inclusion < 0")
plot(hypothesis(m1, "Lag_inclusion < 0"))

# Significant effect of Diagnosis in US?
hypothesis(m1, "Lag_differentiation < 0")
plot(hypothesis(m1, "Lag_differentiation < 0"))

# Significant difference between DK and US?
hypothesis(m1, "Lag_inclusion:Lag_differentiation < 0")
plot(hypothesis(m1, "Lag_inclusion:Lag_differentiation < 0"))
```

# ----------------------------- MODEL WITH DIFFERENTIATION -------------------------
```{r}
###################### DEFINING MODEL AND MAKING PRIOR-PREDICTIVE CHECKS ######################

f2 <- bf(Differentiation ~ 1 + Lag_differentiation +  Lag_inclusion + Lag_differentiation:Lag_inclusion + (1|Parti), family = lognormal())

get_prior(f2, data = agg)

# Finding prior for random intercept
means <- agg %>% group_by(Parti, Date) %>% summarise(mean = mean(sd_theta),
                                      sd = sd(sd_theta)) %>% summarise(mean_of_mean = mean(mean),
                                                                       sd_of_mean = sd(mean))


mean(means$mean_of_mean)
# Mean of 0.4606071

mean(means$sd_of_mean)
# sd of 0.2353983

prior_m2 <- c(
  prior(normal(-1.074466, 0.2), class = Intercept),
  prior(normal(0, 0.2), class = b),
  prior(normal(0.4486, 0.2428), class = sd),
  prior(normal(0.3637625, 0.2), class = sigma)
)

# Running the model
m2_prior <- brm(
  formula = f2,
  data = na.omit(agg),
  family = lognormal(),
  prior = prior_m2, 
  sample_prior = "only",
  chains = 1,
  cores = 1,
  backend = "cmdstanr"
  #file = here("models", "m2_prior")
  )


# Prior predictive check
pp_check(m2_prior, nsamples = 100)
```


```{r}
############################ RUNNING THE MODEL WITH DATA  #####################################
# Running the model
m2 <- brm(
  formula = f2,
  data = na.omit(agg),
  family = gaussian(),
  prior = prior_m2, 
  sample_prior = T,
  chains = 1,
  cores = 1,
  backend = "cmdstanr"#,
  #file = here("models", "m1")
  )


# Posterior predictive check
pp_check(m2, nsamples = 100)

```
```{r}
summary(m2)
```
